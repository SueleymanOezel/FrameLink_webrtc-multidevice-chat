<!doctype html>
<html>
  <head>
    <title>WebSocket Debug Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .pending {
        background-color: #cce5ff;
        border-color: #b8daff;
        color: #004085;
      }
      #log {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        height: 400px;
        overflow: auto;
        background-color: white;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      .test-section {
        background-color: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <h1>WebSocket Connection Debugger</h1>

    <div class="test-section">
      <h2>Railway WebSocket Test</h2>
      <p><strong>TCP Proxy URL:</strong> ws://shortline.proxy.rlwy.net:21652</p>
      <div id="wsStatus" class="status">Nicht getestet</div>
      <button id="testWs">WebSocket testen</button>
    </div>

    <div class="test-section">
      <h2>Kamera Test</h2>
      <div id="cameraStatus" class="status">Nicht getestet</div>
      <button id="testCamera">Kamera testen</button>
      <video
        id="testVideo"
        style="width: 200px; display: none"
        autoplay
        muted
      ></video>
    </div>

    <div class="test-section">
      <h2>WebRTC Test</h2>
      <div id="rtcStatus" class="status">Nicht getestet</div>
      <button id="testRtc">WebRTC testen</button>
    </div>

    <h2>Debug Log</h2>
    <button id="clearLog">Log löschen</button>
    <div id="log"></div>

    <script>
      const wsStatusEl = document.getElementById("wsStatus");
      const cameraStatusEl = document.getElementById("cameraStatus");
      const rtcStatusEl = document.getElementById("rtcStatus");
      const logEl = document.getElementById("log");
      const testVideo = document.getElementById("testVideo");

      function log(message, isError = false) {
        const entry = document.createElement("div");
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (isError) {
          entry.style.color = "red";
        }
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
      }

      // WebSocket Test
      document.getElementById("testWs").addEventListener("click", () => {
        wsStatusEl.textContent = "Teste Verbindung...";
        wsStatusEl.className = "status pending";

        const wsUrl = "ws://shortline.proxy.rlwy.net:21652";
        log(`Versuche Verbindung zu ${wsUrl}`);

        try {
          const socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            log("✅ WebSocket verbunden!");
            wsStatusEl.textContent = "Verbindung erfolgreich!";
            wsStatusEl.className = "status success";

            // Test-Nachricht senden
            const testMsg = JSON.stringify({ type: "test", time: Date.now() });
            socket.send(testMsg);
            log("Test-Nachricht gesendet");

            // Nach 3 Sekunden schließen
            setTimeout(() => {
              socket.close();
              log("WebSocket geschlossen");
            }, 3000);
          };

          socket.onerror = (error) => {
            log("❌ WebSocket Fehler", true);
            wsStatusEl.textContent = "Verbindungsfehler!";
            wsStatusEl.className = "status error";
          };

          socket.onclose = (event) => {
            log(`WebSocket geschlossen: Code ${event.code}`);
          };

          socket.onmessage = (event) => {
            log(`Nachricht empfangen: ${event.data}`);
          };
        } catch (error) {
          log(`Fehler: ${error.message}`, true);
          wsStatusEl.textContent = `Fehler: ${error.message}`;
          wsStatusEl.className = "status error";
        }
      });

      // Kamera Test
      document
        .getElementById("testCamera")
        .addEventListener("click", async () => {
          cameraStatusEl.textContent = "Teste Kamera...";
          cameraStatusEl.className = "status pending";

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });

            log("✅ Kamera-Zugriff erfolgreich");
            testVideo.srcObject = stream;
            testVideo.style.display = "block";

            cameraStatusEl.textContent = "Kamera funktioniert!";
            cameraStatusEl.className = "status success";

            // Nach 5 Sekunden stoppen
            setTimeout(() => {
              stream.getTracks().forEach((track) => track.stop());
              testVideo.style.display = "none";
              log("Kamera gestoppt");
            }, 5000);
          } catch (error) {
            log(`❌ Kamera-Fehler: ${error.message}`, true);
            cameraStatusEl.textContent = `Fehler: ${error.message}`;
            cameraStatusEl.className = "status error";
          }
        });

      // WebRTC Test
      document.getElementById("testRtc").addEventListener("click", async () => {
        rtcStatusEl.textContent = "Teste WebRTC...";
        rtcStatusEl.className = "status pending";

        try {
          const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });

          log("RTCPeerConnection erstellt");

          // Data Channel für Test
          const dc = pc.createDataChannel("test");

          // ICE Gathering Test
          let candidateFound = false;
          pc.onicecandidate = (event) => {
            if (event.candidate) {
              candidateFound = true;
              log(
                `ICE Candidate gefunden: ${event.candidate.candidate.substr(0, 50)}...`
              );
            }
          };

          // Offer erstellen
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          log("Offer erstellt");

          // Auf ICE Gathering warten
          setTimeout(() => {
            if (candidateFound) {
              rtcStatusEl.textContent = "WebRTC funktioniert!";
              rtcStatusEl.className = "status success";
            } else {
              rtcStatusEl.textContent = "Keine ICE Candidates gefunden";
              rtcStatusEl.className = "status error";
            }
            pc.close();
          }, 3000);
        } catch (error) {
          log(`❌ WebRTC-Fehler: ${error.message}`, true);
          rtcStatusEl.textContent = `Fehler: ${error.message}`;
          rtcStatusEl.className = "status error";
        }
      });

      // Log löschen
      document.getElementById("clearLog").addEventListener("click", () => {
        logEl.innerHTML = "";
        log("Log gelöscht");
      });

      // Initial Log
      log("Debug-Tool bereit");
      log("Railway TCP Proxy: ws://shortline.proxy.rlwy.net:21652");
    </script>
  </body>
</html>
